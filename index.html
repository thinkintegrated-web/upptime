<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Status</title>
  <style>
    /* Put it where you want; these are just nice defaults */
    .sites-header { display:grid; grid-template-columns:1.6fr .6fr .6fr .8fr; gap:.75rem;
      padding:.75rem 1rem; font-weight:600; background:#f6f7f9; border:1px solid #e3e6ea;
      border-radius:.5rem; margin:1rem 0 .75rem }
    .sites { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:.75rem }
    .site-card { display:grid; grid-template-columns:1.6fr .6fr .6fr .8fr; gap:.75rem; align-items:center;
      padding:1rem; border:1px solid #e3e6ea; border-radius:.75rem; background:#fff }
    .site-card .url { display:flex; align-items:center; gap:.5rem }
    .pill { padding:.2rem .5rem; border-radius:999px; font-size:.875rem }
    .pill.up { background:#e8f7ee; color:#207d41 }
    .pill.down { background:#fde8e8; color:#b42318 }
  </style>
</head>
<body>

  <!-- YOU choose where this header lives -->
  <header class="sites-header">
    <div>URL</div><div>Status</div><div>Response</div><div>Uptime</div>
  </header>

  <!-- YOU choose where the cards list appears -->
  <section id="sites" class="sites"></section>

  <!-- Optional: put additional sections anywhere and populate them by ID -->
  <section id="fastest" style="margin-top:1.5rem;"></section>

  <template id="site-card-tpl">
    <article class="site-card">
      <div class="url"><img data-favicon height="13" alt="" /><a data-link></a></div>
      <div class="status"><span class="pill" data-status></span></div>
      <div class="response" data-response></div>
      <div class="uptime" data-uptime></div>
    </article>
  </template>

  <script>
/* ---------- robust base + discovery + debug ---------- */

// Figure out the base path of the repo (works for /, /repo/, and custom domains)
function getApiBase() {
  // directory containing index.html, e.g. "/" or "/uptime/"
  const dir = location.pathname.endsWith('/') ? location.pathname : location.pathname.replace(/\/[^/]*$/, '/');
  return dir + 'api'; // /api sits next to index.html
}

const apiBase = getApiBase();

// Simple on-page debug panel
const debug = (msg) => {
  let box = document.getElementById('debug');
  if (!box) {
    box = document.createElement('pre');
    box.id = 'debug';
    box.style.cssText = 'background:#111;color:#9fe;padding:8px;border-radius:6px;font-size:12px;white-space:pre-wrap;margin-top:16px;';
    document.body.appendChild(box);
  }
  box.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n';
};

// Render helpers
function statusPill(upNow) {
  const span = document.createElement('span');
  span.className = 'pill ' + (upNow ? 'up' : 'down');
  span.textContent = upNow ? 'Up' : 'Down';
  return span;
}

function renderCard(container, site, data) {
  const article = document.createElement('article');
  article.className = 'site-card';

  const url = document.createElement('div');
  url.className = 'url';
  const fav = document.createElement('img');
  fav.height = 13; fav.alt = '';
  try { fav.src = 'https://icons.duckduckgo.com/ip3/' + new URL(site.url).host + '.ico'; } catch(e) {}
  const a = document.createElement('a');
  a.href = site.url; a.textContent = site.name || site.url;
  url.append(fav, a);

  const status = document.createElement('div');
  status.className = 'status';
  const upNow = (data.status?.status || '').toLowerCase() === 'up' || data.summary?.status === 'up';
  status.appendChild(statusPill(upNow));

  const response = document.createElement('div');
  response.className = 'response';
  const ms = data.responseMs ?? data.resp?.last24h ?? data.resp?.average ?? data.resp?.daily?.slice(-1)?.[0]?.value;
  response.textContent = (ms != null && isFinite(ms)) ? Math.round(ms) + ' ms' : '—';

  const uptime = document.createElement('div');
  uptime.className = 'uptime';
  const pct = data.up?.overall ?? data.summary?.uptime ?? data.up?.weekly?.slice(-1)?.[0]?.uptime;
  uptime.textContent = (pct != null && isFinite(pct)) ? Number(pct).toFixed(2) + '%' : '—';

  article.append(url, status, response, uptime);
  container.appendChild(article);
}

async function fetchJson(path) {
  const url = `${apiBase}/${path}`;
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return await res.json();
  } catch (e) {
    debug(`Fetch failed: ${url} → ${e.message}`);
    return null;
  }
}

async function getSiteMetrics(slug) {
  // Try the file names used by recent Upptime versions
  const [status, resp, up] = await Promise.all([
    fetchJson(`${slug}/status.json`)            // has .status = "up" | "down"
      .then(j => j || fetchJson(`${slug}/summary.json`)), // fallback
    fetchJson(`${slug}/response-time.json`),
    fetchJson(`${slug}/uptime.json`)
  ]);
  return { status, resp, up };
}

(async function init() {
  debug(`apiBase resolved to: ${apiBase}`);

  // Discover sites from summary.json (generated by Upptime)
  const summary = await fetchJson(`summary.json`);
  if (!summary || !Array.isArray(summary)) {
    debug('No /api/summary.json found or not an array. Check that /api exists next to index.html.');
    return;
  }

  // summary entries typically look like:
  // { "slug": "example-com", "url": "https://example.com", "name": "example.com", "status": "up", "uptime": 99.99, ... }
  const sites = summary.map(s => ({
    slug: s.slug,
    url: s.url || (s.site || ''),
    name: s.name || s.title || s.slug,
    _summary: s
  }));

  const list = document.getElementById('sites');
  if (!list) {
    debug('Missing #sites container in the HTML.');
    return;
  }

  for (const site of sites) {
    const metrics = await getSiteMetrics(site.slug);
    // pass through some summary values in case per-site files are missing
    metrics.summary = { status: site._summary.status, uptime: site._summary.uptime };
    // Some Upptime versions expose "responseTime" on summary
    if (typeof site._summary.responseTime === 'number') metrics.responseMs = site._summary.responseTime;
    renderCard(list, site, metrics);
  }
})();
</script>

</body>
</html>
